#!/bin/bash
#
# rails-post-deploy
# For Ruby on Rails, run this in exec_extras in vhosts.pl. It makes symlinks
# from vendor to the server version of rails, and migrates the db to the most
# recent version.
#
# Copyright (c) 2007 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: rails-post-deploy,v 1.18 2009-09-03 23:44:50 francis Exp $
#

set -e
#set -x # debug

APP_DIR=`pwd`

# make sure that there is an app directory, so are in a rails app tree
cd app/..

# read config file in for later (STAGING_SITE)
if [ -e "config/general" ] || [ -e "config/general.yml" ]
then
    . commonlib/shlib/deployfns
    read_conf config/general
else
    OPTION_DOMAIN=127.0.0.1:3000
    OPTION_STAGING_SITE=1
fi

# create initial log files
if [ -e $APP_DIR/../logs ]
then
    # mySociety servers have logs dir in level above
    rm -f log
    ln -s $APP_DIR/../logs log
else
    # otherwise just make the directory
    if [ -h log ]
    then
        # remove any old-style symlink first
        rm -f log
    fi
    mkdir -p log
fi
# link the "downloads" directory in the cache to somewhere it can be served
if [ ! -e $APP_DIR/public/download ]
then
    mkdir -p $APP_DIR/cache/zips/download
    ln -s $APP_DIR/cache/zips/download $APP_DIR/public/
fi

cd log
touch development.log fastcgi.crash.log production.log test.log
cd ..

if [ -n "$OPTION_THEME_URL" ]
then
    script/plugin install --force $OPTION_THEME_URL
fi

# upgrade database
rake db:migrate #--trace


